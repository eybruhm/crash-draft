-- This is the supabase code use by my friend in his mobile dev. It is messy and not exactly like my supabase code. 


-- Enables the function to generate UUIDs


CREATE EXTENSION IF NOT EXISTS "uuid-ossp";






---


-- STEP 1: CREATE CUSTOM ENUM TYPES (Safely)


---


DO $$


BEGIN


    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'message_sender_type_enum') THEN


        CREATE TYPE message_sender_type_enum AS ENUM ('user', 'police_office', 'admin');


    END IF;


   


    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'report_status_enum') THEN


        CREATE TYPE report_status_enum AS ENUM ('pending', 'assigned', 'investigating', 'resolved', 'closed');


    END IF;


   


    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'media_file_type_enum') THEN


        CREATE TYPE media_file_type_enum AS ENUM ('image', 'video', 'audio');


    END IF;


END$$;






---


-- STEP 2: CREATE TABLES (If they don't exist)


---






-- User table


CREATE TABLE IF NOT EXISTS tbl_users (


    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    email VARCHAR(255) UNIQUE NOT NULL,


    phone VARCHAR(50) UNIQUE,


    password_hash VARCHAR(255) NOT NULL,


    first_name VARCHAR(100),


    last_name VARCHAR(100),


    birthdate DATE,


    sex VARCHAR(20),


    emergency_contact_name VARCHAR(255),


    emergency_contact_number VARCHAR(50),


    region VARCHAR(100),


    city VARCHAR(100),


    barangay VARCHAR(100),


    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Admin table


CREATE TABLE IF NOT EXISTS tbl_admin (


    admin_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    username VARCHAR(100) UNIQUE NOT NULL,


    email VARCHAR(255) UNIQUE NOT NULL,


    password VARCHAR(255) NOT NULL,


    contact_no VARCHAR(50),


    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Police offices table


CREATE TABLE IF NOT EXISTS tbl_police_offices (


    office_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    office_name VARCHAR(255) NOT NULL,


    head_officer VARCHAR(255),


    contact_number VARCHAR(50),


    latitude NUMERIC(10, 7),


    longitude NUMERIC(10, 7),


    created_by UUID,


    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Reports table


CREATE TABLE IF NOT EXISTS tbl_reports (


    report_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    reporter_id UUID,


    assigned_office_id UUID,


    category VARCHAR(100),


    description TEXT,


    status report_status_enum DEFAULT 'pending',


    latitude NUMERIC(10, 7),


    longitude NUMERIC(10, 7),


    location_city VARCHAR(50),


    location_barangay VARCHAR(50),


    remarks TEXT,


    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,


    updated_at TIMESTAMP


);






-- Messages table


CREATE TABLE IF NOT EXISTS tbl_messages (


    message_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    report_id UUID,


    sender_id UUID,


    sender_type message_sender_type_enum,


    receiver_id UUID,


    message_content TEXT,


    "timestamp" TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Media table


CREATE TABLE IF NOT EXISTS tbl_media (


    media_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    file_url VARCHAR(1024) NOT NULL,


    report_id UUID,


    file_type media_file_type_enum,


    sender_id UUID,


    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Checkpoints table


CREATE TABLE IF NOT EXISTS tbl_checkpoints (


    checkpoint_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    office_id UUID,


    checkpoint_name VARCHAR(255),


    latitude NUMERIC(10, 7),


    longitude NUMERIC(10, 7),


    assigned_officers TEXT,


    schedule VARCHAR(255),


    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP


);






-- Analytics summary table


CREATE TABLE IF NOT EXISTS tbl_summary_analytics (


    summary_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


    location_city VARCHAR(100),


    location_barangay VARCHAR(100),


    category VARCHAR(100),


    report_count INT4,


    last_updated TIMESTAMP


);






---


-- STEP 3: ENSURE NEW COLUMNS EXIST


---


ALTER TABLE tbl_reports ADD COLUMN IF NOT EXISTS location_city VARCHAR(50);


ALTER TABLE tbl_reports ADD COLUMN IF NOT EXISTS location_barangay VARCHAR(50);






---


-- STEP 4: ADD FOREIGN KEY CONSTRAINTS


---


DO $$


BEGIN


    -- Police Offices -> Admin


    BEGIN


        ALTER TABLE tbl_police_offices


        ADD CONSTRAINT fk_admin_created_by


        FOREIGN KEY (created_by) REFERENCES tbl_admin(admin_id);


    EXCEPTION WHEN duplicate_object THEN NULL; END;






    -- Reports -> Users


    BEGIN


        ALTER TABLE tbl_reports


        ADD CONSTRAINT fk_user_reporter


        FOREIGN KEY (reporter_id) REFERENCES tbl_users(user_id);


    EXCEPTION WHEN duplicate_object THEN NULL; END;






    -- Reports -> Offices


    BEGIN


        ALTER TABLE tbl_reports


        ADD CONSTRAINT fk_office_assigned


        FOREIGN KEY (assigned_office_id) REFERENCES tbl_police_offices(office_id);


    EXCEPTION WHEN duplicate_object THEN NULL; END;






    -- Messages -> Reports


    BEGIN


        ALTER TABLE tbl_messages


        ADD CONSTRAINT fk_report_messages


        FOREIGN KEY (report_id) REFERENCES tbl_reports(report_id) ON DELETE CASCADE;


    EXCEPTION WHEN duplicate_object THEN NULL; END;






    -- Media -> Reports


    BEGIN


        ALTER TABLE tbl_media


        ADD CONSTRAINT fk_report_media


        FOREIGN KEY (report_id) REFERENCES tbl_reports(report_id) ON DELETE CASCADE;


    EXCEPTION WHEN duplicate_object THEN NULL; END;






    -- Checkpoints -> Offices


    BEGIN


        ALTER TABLE tbl_checkpoints


        ADD CONSTRAINT fk_office_checkpoint


        FOREIGN KEY (office_id) REFERENCES tbl_police_offices(office_id);


    EXCEPTION WHEN duplicate_object THEN NULL; END;


END$$;










-- ============================================================


-- STEP 5: VIEW ONLY - NEARBY SEARCH


-- ============================================================


-- Use this if you just want to SHOW the list on a map (without reporting yet)


DROP FUNCTION IF EXISTS get_nearby_police;






CREATE OR REPLACE FUNCTION get_nearby_police(user_lat float, user_long float)


RETURNS TABLE (


  office_id uuid,


  office_name varchar,


  contact_number varchar,


  latitude numeric,


  longitude numeric,


  dist_meters float


)


LANGUAGE sql


AS $$


  SELECT


    office_id,


    office_name,


    contact_number,


    latitude,


    longitude,


    (


      6371000 * acos(


        cos(radians(user_lat)) * cos(radians(latitude)) *


        cos(radians(longitude) - radians(user_long)) +


        sin(radians(user_lat)) * sin(radians(latitude))


      )


    ) AS dist_meters


  FROM


    tbl_police_offices


  ORDER BY


    dist_meters ASC


  LIMIT 5;


$$;










-- ============================================================


-- STEP 6: (NEW) AUTO-CONNECT SOS FUNCTION


-- ============================================================


-- Use this for the "SOS Button".


-- It finds the nearest police, creates a report, and returns the ID for chat.






DROP FUNCTION IF EXISTS create_emergency_sos;






CREATE OR REPLACE FUNCTION create_emergency_sos(


  p_user_id uuid,


  p_lat float,


  p_long float,


  p_category text,


  p_description text


)


RETURNS json


LANGUAGE plpgsql


AS $$


DECLARE


  v_nearest_office_id uuid;


  v_nearest_office_name text;


  v_new_report_id uuid;


BEGIN


  -- 1. Find the SINGLE nearest office


  SELECT office_id, office_name


  INTO v_nearest_office_id, v_nearest_office_name


  FROM tbl_police_offices


  ORDER BY (


      6371000 * acos(


        cos(radians(p_lat)) * cos(radians(latitude)) *


        cos(radians(longitude) - radians(p_long)) +


        sin(radians(p_lat)) * sin(radians(latitude))


      )


  ) ASC


  LIMIT 1;






  -- 2. Error Check: Did we find one?


  IF v_nearest_office_id IS NULL THEN


    RAISE EXCEPTION 'No police stations found in database.';


  END IF;






  -- 3. Create the Report (The Connection)


  INSERT INTO tbl_reports (


    reporter_id,


    assigned_office_id,


    latitude,


    longitude,


    category,


    description,


    status,


    created_at


  )


  VALUES (


    p_user_id,


    v_nearest_office_id,


    p_lat,


    p_long,


    p_category,


    p_description,


    'pending',


    NOW()


  )


  RETURNING report_id INTO v_new_report_id;






  -- 4. Return the details to the App


  RETURN json_build_object(


    'report_id', v_new_report_id,


    'assigned_office_id', v_nearest_office_id,


    'assigned_office_name', v_nearest_office_name,


    'message', 'SOS Sent! Connected to nearest station.'


  );


END;


$$;






---
-- STEP 1: CREATE CUSTOM ENUM TYPES (Updated to Capitalized)
---
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'message_sender_type_enum') THEN
        CREATE TYPE message_sender_type_enum AS ENUM ('user', 'police_office', 'admin');
    END IF;
   
    -- [UPDATED] Matches your UI Dropdown exactly
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'report_status_enum') THEN
        CREATE TYPE report_status_enum AS ENUM (
            'Pending',
            'Acknowledged',
            'En Route',
            'Resolved',
            'On Scene',
            'Canceled'
        );
    END IF;
   
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'media_file_type_enum') THEN
        CREATE TYPE media_file_type_enum AS ENUM ('image', 'video', 'audio');
    END IF;
END$$;


---
-- STEP 2: CREATE TABLES
---


-- [A] User table... (No changes needed here)


-- [D] Reports table (UPDATED Default Value)
CREATE TABLE IF NOT EXISTS tbl_reports (
    report_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reporter_id UUID,
    assigned_office_id UUID,
    category VARCHAR(100),
    description TEXT,
    -- [UPDATED] Default is now Capitalized 'Pending'
    status report_status_enum DEFAULT 'Pending',
    latitude NUMERIC(10, 7),
    longitude NUMERIC(10, 7),
    location_city VARCHAR(50),
    location_barangay VARCHAR(50),
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);








