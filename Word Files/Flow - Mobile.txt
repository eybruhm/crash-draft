Note:
Ignore some endpoints and functions because these are just samples and draft.
Remember: supabase storage is our media storage natin.


Flow 1: Citizen Sign Up and Account Creation

User Action: Fills out mandatory fields (Email, Name, Birthdate, Password, Address, Emergency Contact Info) and taps "Create Account".
App Action:
Gathers all form data.
Hashes the password securely on the client or sends it securely for hashing on the backend.
Uses Axios to send a POST request to the /api/auth/register/ endpoint.
Database Interaction (Supabase):
INSERT command is executed on the tbl_users table.
Data Fields: email, phone, password_hash, first_name, last_name, birthdate, city, barangay, emergency_contact_number (and others) are populated.
Data Rows: A new row is created, and the user_id (UUID) and created_at timestamp are automatically generated by the database.
App Output: Success message, Auto-login, navigates to Home/SOS page.

Flow 2: Immediate SOS Report Submission (Online)

This flow is for rapid, minimal reporting when the user is logged in and online.
User Action: Taps the Big Red SOS Button on Page 1 (Home).
App Action:
Checks for and requires GPS Permission.
Device GPS is used to get the current latitude and longitude.
Sets default report fields: category = 'Emergency' (default) , description = Empty/Default, role = 'Victim' (default).
Uses Axios to send a POST request to the /api/reports/ endpoint.
Database Interaction (Supabase):
INSERT command is executed on the tbl_reports table.
Data Fields: reporter_id (from logged-in user), category, latitude, longitude are populated.
Data Rows: A new row is inserted, and the status defaults to 'Pending'.
App Output: Success message ("Report Sent Successfully") , Active Chat Head appears, and the SOS button is disabled.

Flow 3: Detailed Report Submission with Media (Online)

This flow is for submitting a comprehensive report on Page 2.
User Action: Fills out Description, selects Category (e.g., Theft), attaches an optional Image/Video, and taps "Send Report".
App Action:
Checks for and requires GPS Permission. Device GPS is used to get the current latitude and longitude.
A. Media Upload: Sends the file to the dedicated Supabase Storage service. Receives a secure file_url back.
B. Report Submission: Uses Axios to send POST (multipart/form-data) to /api/reports/ with all form fields and the report's latitude/longitude.
Database Interaction (Supabase):
INSERT 1 (tbl_reports): New report row is inserted with all form data.
INSERT 2 (tbl_media): New row is inserted using the file_url (from Step A) and the new report_id (from Insert 1).
Data Fields (tbl_media): report_id (FK), file_url, file_type ('image' or 'video'), sender_id.
App Output: Success message, Active Chat Head appears, and the Send Report button is disabled.

Flow 4: Real-Time Status Update and Messaging

This flow demonstrates the two-way, real-time communication enabled by Supabase Realtime.
Police Action: Officer on Web Dashboard changes report status from 'Pending' to 'Acknowledged'.
Supabase Interaction:
UPDATE command runs on tbl_reports setting status to 'Acknowledged'.
The database trigger automatically updates the updated_at timestamp.
Supabase Realtime service detects the change on tbl_reports.
App Output: The citizen's React Native app, which is subscribed to tbl_reports via Realtime, instantly updates the status in the Active Chat Head

Flow 5: Citizen Sends a Message to Police

This flow occurs when the user has an active case and the Active Chat Head is visible.
User Action: Taps the Active Chat Head, types a message (e.g., "I see the police car now"), and taps "Send Message".
App Action:
App checks the user's current session to get the sender_id (tbl_users.user_id).
Sets the sender_type to 'user'.
Uses Axios to send a POST request to the messaging endpoint, like /api/reports/<report_id>/messages/.
Database Interaction (Supabase):
INSERT command is executed on the tbl_messages table.
Data Fields: report_id (FK to the active case), sender_id (user's UUID), sender_type ('user'), message_content, and timestamp are populated.
App Output: The message instantly appears in the conversation box for the citizen, and the Police Web Dashboard (which is subscribed via Realtime) is immediately notified of the new message.

Flow 6: Police Sends a Message to Citizen (Real-Time Receive)

This flow is initiated by the police officer, demonstrating the Real-time functionality.
Police Action: Officer on Web Dashboard types a message (e.g., "We are on the way to your location.") and taps "Send Message".
Police System Action:
Police system uses the police office's office_id as the sender_id.
Sets the sender_type to 'police'.
Sends a POST request to the messaging endpoint, inserting a new row into tbl_messages.
Supabase Interaction:
INSERT command completes on tbl_messages.
Supabase Realtime service detects the change on the tbl_messages table for that specific report_id.
App Output: The citizen's React Native app, which is subscribed to tbl_messages via Realtime, instantly displays the new message from the police. The Active Chat Head may flash or show a notification bubble.

Flow 7: Case Resolution and Chat Closure

This flow terminates the chat and removes the "Active Case" status.
Police Action: Officer on Web Dashboard changes the report status to 'Resolved'.
Police System Action: Sends a PATCH request to /api/reports/<report_id>/ with {"status": "Resolved"}.
Database Interaction (Supabase):
UPDATE command is executed on tbl_reports setting status to 'Resolved'.
The database trigger updates the updated_at timestamp.
A backend function is triggered to UPDATE/INSERT a row into tbl_summary_analytics to increment the report_count for the resolved case's location and category.
App Output:
Supabase Realtime pushes the 'Resolved' status to the citizen's app.
The Active Chat Head disappears, or shows a final 'Case Resolved' notification.
The SOS Button on Page 1 is re-enabled, allowing the user to file a new report.
 

